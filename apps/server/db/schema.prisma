generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}
enum ChatRoomRole {
  OWNER
  ADMIN
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MessageType {
  TEXT
  FILE
}
model ChatRoom {
  id             String           @id @default(cuid())
  name           String
  description    String?
  createdBy      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  User           User             @relation(fields: [createdBy], references: [id])

  ChatRoomMember ChatRoomMember[]
  Message        Message[]
  invitations    RoomInvitation[]
  joinRequests   RoomJoinRequest[]
  joinLinks      RoomJoinLink[]


}

model ChatRoomMember {
  id         String       @id @default(cuid())
  userId     String
  chatRoomId String
  role       ChatRoomRole @default(MEMBER)
  joinedAt   DateTime     @default(now())

  ChatRoom   ChatRoom     @relation(fields: [chatRoomId], references: [id])
  User       User         @relation(fields: [userId], references: [id])

  @@unique([userId, chatRoomId])
  @@index([chatRoomId])
  @@index([userId])
  
}



model Message {
  id           String      @id @default(cuid())
  content      String?
  senderId     String
  chatRoomId   String?
  directChatId String?

  messageType  MessageType
  fileUri      String?
  fileName     String?
  fileSize     Int?

  createdAt    DateTime    @default(now())

  isDeleted    Boolean     @default(false)
  deletedAt    DateTime?
  editedAt     DateTime?

  ChatRoom     ChatRoom?   @relation(fields: [chatRoomId], references: [id])
  DirectChat   DirectChat? @relation(fields: [directChatId], references: [id])
  User         User        @relation(fields: [senderId], references: [id])

  @@index([chatRoomId, createdAt])
  @@index([directChatId, createdAt])
}

model DirectChat {
  id                            String    @id @default(cuid())
  user1Id                       String
  user2Id                       String
  createdAt                     DateTime  @default(now())
  lastMessageAt                 DateTime?
  User_DirectChat_user1IdToUser User      @relation("DirectChat_user1IdToUser", fields: [user1Id], references: [id])
  User_DirectChat_user2IdToUser User      @relation("DirectChat_user2IdToUser", fields: [user2Id], references: [id])
  Message                       Message[]

  @@unique([user1Id, user2Id])
}

model User {
  id                                  String           @id
  email                               String           @unique
  username                            String           @unique
  passwordHash                        String?
  avatar                              String?
  createdAt                           DateTime         @default(now())
  updatedAt                           DateTime
  ChatRoom                            ChatRoom[]
  ChatRoomMember                      ChatRoomMember[]
  DirectChat_DirectChat_user1IdToUser DirectChat[]     @relation("DirectChat_user1IdToUser")
  DirectChat_DirectChat_user2IdToUser DirectChat[]     @relation("DirectChat_user2IdToUser")
  Message                             Message[]
  joinRequests                        RoomJoinRequest[]
  reviewedJoinRequests                RoomJoinRequest[] @relation("JoinRequestReviewedBy")


  receivedInvitations                 RoomInvitation[] @relation("InvitedUser")
  sentInvitations                     RoomInvitation[] @relation("InvitedBy")
  createdJoinLinks                    RoomJoinLink[]

}

model RoomInvitation {
  id              String   @id @default(uuid())

  roomId          String
  room            ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  invitedUserId   String
  invitedUser     User     @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: Cascade)

  invitedById     String
  invitedBy       User     @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)

  status          InvitationStatus @default(PENDING)

  createdAt       DateTime @default(now())
}



model RoomJoinRequest {
  id                    String                  @id @default(uuid())

  roomId                String  
  room                  ChatRoom                @relation(fields: [roomId], references: [id], onDelete: Cascade)

  userId                String
  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  status                JoinRequestStatus       @default(PENDING)

  reviewedById          String?
  reviewedBy            User?                   @relation("JoinRequestReviewedBy", fields: [reviewedById], references: [id])

  createdAt             DateTime                @default(now())
  reviewedAt            DateTime?


}

model RoomJoinLink {
  id                    String                  @id @default(uuid())

  token                 String                  @unique
  roomId                String
  room                  ChatRoom                @relation(fields: [roomId], references: [id], onDelete: Cascade)

  createdById           String
  createdBy             User                    @relation(fields: [createdById], references: [id], onDelete: Cascade)

  maxUses               Int?
  usedCount             Int                     @default(0)

  expiresAt             DateTime?
  isActive              Boolean                 @default(true)

  createdAt             DateTime                @default(now())
}